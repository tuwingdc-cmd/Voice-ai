const{Client,GatewayIntentBits,EmbedBuilder,ActionRowBuilder,StringSelectMenuBuilder,ButtonBuilder,ButtonStyle,ActivityType,AttachmentBuilder,Events}=require('discord.js');
const{joinVoiceChannel,createAudioPlayer,createAudioResource,AudioPlayerStatus,VoiceConnectionStatus,entersState,getVoiceConnection,StreamType}=require('@discordjs/voice');
const{exec}=require('child_process');
const{createServer}=require('http');
const https=require('https');
const fs=require('fs');
const path=require('path');
const startTime=Date.now();
const healthServer=createServer((req,res)=>{res.writeHead(200,{'Content-Type':'application/json'});res.end(JSON.stringify({status:'ok',version:'2.13.0',uptime:Math.floor((Date.now()-startTime)/1000)}));});
healthServer.listen(process.env.PORT||3000,()=>console.log('ğŸŒ Health server ready'));
const CONFIG={token:process.env.DISCORD_TOKEN,prefix:'.',adminIds:(process.env.ADMIN_IDS||'').split(',').filter(Boolean),dataPath:'./data/settings.json',tempPath:'./temp',tavilyApiKey:process.env.TAVILY_API_KEY,serperApiKey:process.env.SERPER_API_KEY,geminiApiKey:process.env.GEMINI_API_KEY,groqApiKey:process.env.GROQ_API_KEY,openrouterApiKey:process.env.OPENROUTER_API_KEY,huggingfaceApiKey:process.env.HUGGINGFACE_API_KEY,elevenLabsApiKey:process.env.ELEVENLABS_API_KEY,pollinationsApiKey:process.env.POLLINATIONS_API_KEY,ttsMaxChunkLength:1000,ttsMaxTotalLength:10000,ttsMinChunkLength:50,ttsConcatTimeout:120000,ttsGenerateTimeout:60000,voiceInactivityTimeout:300000,maxConversationMessages:100,maxConversationAge:7200000,rateLimitWindow:60000,rateLimitMax:30};
const rateLimits=new Map();
function checkRateLimit(u){const n=Date.now(),l=rateLimits.get(u);if(!l||n>l.resetAt){rateLimits.set(u,{count:1,resetAt:n+CONFIG.rateLimitWindow});return{allowed:true};}if(l.count>=CONFIG.rateLimitMax)return{allowed:false,waitTime:Math.ceil((l.resetAt-n)/1000)};l.count++;return{allowed:true};}
setInterval(()=>{const n=Date.now();for(const[u,l]of rateLimits)if(n>l.resetAt)rateLimits.delete(u);},60000);
const SEARCH_TRIGGERS=['berita','news','terbaru','hari ini','sekarang','latest','today','recent','update','siapa presiden','harga','kurs','cuaca','jadwal','skor','trending','viral','2024','2025','2026','2027'];
function shouldSearch(m){const l=m.toLowerCase();return SEARCH_TRIGGERS.some(t=>l.includes(t));}
function getCurrentDateTime(){return new Date().toLocaleDateString('id-ID',{weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',timeZone:'Asia/Jakarta'})+' WIB';}
async function searchTavily(q){if(!CONFIG.tavilyApiKey)return null;return new Promise(r=>{const d=JSON.stringify({api_key:CONFIG.tavilyApiKey,query:q,search_depth:'basic',include_answer:true,max_results:5});const req=https.request({hostname:'api.tavily.com',path:'/search',method:'POST',headers:{'Content-Type':'application/json','Content-Length':Buffer.byteLength(d)},timeout:15000},res=>{let data='';res.on('data',c=>data+=c);res.on('end',()=>{try{r(res.statusCode===200?JSON.parse(data):null);}catch{r(null);}});});req.on('error',()=>r(null));req.on('timeout',()=>{req.destroy();r(null);});req.write(d);req.end();});}
async function searchSerper(q){if(!CONFIG.serperApiKey)return null;return new Promise(r=>{const d=JSON.stringify({q,gl:'id',hl:'id',num:5});const req=https.request({hostname:'google.serper.dev',path:'/search',method:'POST',headers:{'X-API-KEY':CONFIG.serperApiKey,'Content-Type':'application/json','Content-Length':Buffer.byteLength(d)},timeout:15000},res=>{let data='';res.on('data',c=>data+=c);res.on('end',()=>{try{r(res.statusCode===200?JSON.parse(data):null);}catch{r(null);}});});req.on('error',()=>r(null));req.on('timeout',()=>{req.destroy();r(null);});req.write(d);req.end();});}
async function performSearch(q,p='auto'){const dt=getCurrentDateTime();let s={timestamp:dt,answer:null,facts:[],source:null};if((p==='serper'||p==='auto')&&CONFIG.serperApiKey){const r=await searchSerper(q);if(r){s.source='serper';if(r.answerBox)s.answer=r.answerBox.answer||r.answerBox.snippet;if(r.organic)r.organic.slice(0,4).forEach(i=>{if(i.snippet)s.facts.push(i.snippet);});if(r.knowledgeGraph?.description)s.facts.unshift(r.knowledgeGraph.description);if(s.answer||s.facts.length>0)return s;}}if((p==='tavily'||p==='auto')&&CONFIG.tavilyApiKey){const r=await searchTavily(q);if(r){s.source='tavily';if(r.answer)s.answer=r.answer;if(r.results)r.results.slice(0,4).forEach(i=>{if(i.content)s.facts.push(i.content.slice(0,300));});if(s.answer||s.facts.length>0)return s;}}return null;}
function formatSearchForAI(s){if(!s)return'';let c=`\n\n[INFO TERKINI - ${s.timestamp}]\n`;if(s.answer)c+=`Jawaban: ${s.answer}\n`;if(s.facts.length>0){c+='Fakta:\n';s.facts.forEach(f=>c+=`- ${f}\n`);}c+='\nJawab natural tanpa sebut sumber.';return c;}
const SYSTEM_PROMPT=`Kamu adalah Aria, asisten AI cerdas dan friendly. Jawab dalam Bahasa Indonesia natural. Jangan sebut sumber atau URL. Untuk voice mode, jawab singkat 2-4 kalimat.`;
const POLLINATIONS_MODELS=[{id:'openai',name:'OpenAI GPT',version:'GPT-5-nano'},{id:'openai-fast',name:'OpenAI Fast',version:'GPT-5-fast'},{id:'openai-large',name:'OpenAI Large',version:'GPT-5-large'},{id:'openai-reasoning',name:'OpenAI Reasoning',version:'GPT-5.2'},{id:'claude',name:'Claude',version:'Claude-3.5'},{id:'claude-fast',name:'Claude Fast',version:'Claude-fast'},{id:'claude-large',name:'Claude Large',version:'Claude-large'},{id:'claude-haiku',name:'Claude Haiku',version:'Haiku-4.5'},{id:'claude-sonnet',name:'Claude Sonnet',version:'Sonnet-4.5'},{id:'claude-opus',name:'Claude Opus',version:'Opus-4.5'},{id:'gemini',name:'Gemini',version:'Gemini-3-Flash'},{id:'gemini-fast',name:'Gemini Fast',version:'Gemini-fast'},{id:'gemini-large',name:'Gemini Large',version:'Gemini-large'},{id:'gemini-search',name:'Gemini Search',version:'Gemini-search'},{id:'gemini-legacy',name:'Gemini Legacy',version:'Gemini-2.5'},{id:'deepseek',name:'DeepSeek',version:'V3'},{id:'deepseek-v3',name:'DeepSeek V3',version:'V3-latest'},{id:'deepseek-reasoning',name:'DeepSeek Reasoning',version:'R1'},{id:'mistral',name:'Mistral',version:'Mistral-Small'},{id:'mistral-small',name:'Mistral Small',version:'Mistral-3.2'},{id:'qwen-coder',name:'Qwen Coder',version:'Qwen3-Coder'},{id:'kimi',name:'Kimi',version:'Kimi-K2.5'},{id:'kimi-large',name:'Kimi Large',version:'Kimi-large'},{id:'kimi-reasoning',name:'Kimi Reasoning',version:'Kimi-reasoning'},{id:'grok',name:'Grok',version:'Grok-4'},{id:'grok-fast',name:'Grok Fast',version:'Grok-fast'},{id:'glm',name:'GLM',version:'GLM-4.7'},{id:'minimax',name:'MiniMax',version:'M2.1'},{id:'nova-fast',name:'Nova Fast',version:'Amazon-Nova'},{id:'perplexity-fast',name:'Perplexity Fast',version:'Sonar'},{id:'perplexity-reasoning',name:'Perplexity Reasoning',version:'Sonar-Pro'},{id:'searchgpt',name:'SearchGPT',version:'v1'},{id:'midijourney',name:'Midijourney',version:'v1'},{id:'chickytutor',name:'ChickyTutor',version:'Education'},{id:'nomnom',name:'NomNom',version:'Food'}];
const AI_PROVIDERS={gemini:{name:'Google Gemini',requiresKey:true,keyEnv:'GEMINI_API_KEY',models:[{id:'gemini-2.5-pro',name:'Gemini 2.5 Pro',version:'2.5-pro',category:'stable'},{id:'gemini-2.5-flash',name:'Gemini 2.5 Flash',version:'2.5-flash',category:'stable'},{id:'gemini-2.5-flash-lite',name:'Gemini 2.5 Flash Lite',version:'2.5-lite',category:'stable'},{id:'gemini-2.0-flash',name:'Gemini 2.0 Flash',version:'2.0-flash',category:'stable'},{id:'gemini-1.5-pro',name:'Gemini 1.5 Pro',version:'1.5-pro',category:'stable'},{id:'gemini-1.5-flash',name:'Gemini 1.5 Flash',version:'1.5-flash',category:'stable'}]},groq:{name:'Groq',requiresKey:true,keyEnv:'GROQ_API_KEY',models:[{id:'llama-3.3-70b-versatile',name:'Llama 3.3 70B',version:'v3.3',category:'production'},{id:'llama-3.1-8b-instant',name:'Llama 3.1 8B',version:'v3.1',category:'production'},{id:'openai/gpt-oss-120b',name:'GPT OSS 120B',version:'120B',category:'production'},{id:'openai/gpt-oss-20b',name:'GPT OSS 20B',version:'20B',category:'production'},{id:'meta-llama/llama-4-maverick-17b-128e-instruct',name:'Llama 4 Maverick',version:'17B-128E',category:'preview'},{id:'meta-llama/llama-4-scout-17b-16e-instruct',name:'Llama 4 Scout',version:'17B-16E',category:'preview'},{id:'moonshotai/kimi-k2-instruct-0905',name:'Kimi K2',version:'K2',category:'preview'},{id:'qwen/qwen-3-32b',name:'Qwen 3 32B',version:'32B',category:'preview'},{id:'llama-3-groq-70b-tool-use',name:'Llama 3 70B Tool',version:'70B-tool',category:'tool'},{id:'llama-3-groq-8b-tool-use',name:'Llama 3 8B Tool',version:'8B-tool',category:'tool'}]},pollinations_free:{name:'Pollinations (Free)',requiresKey:false,models:POLLINATIONS_MODELS},pollinations_api:{name:'Pollinations (API)',requiresKey:true,keyEnv:'POLLINATIONS_API_KEY',models:POLLINATIONS_MODELS},openrouter:{name:'OpenRouter',requiresKey:true,keyEnv:'OPENROUTER_API_KEY',models:[{id:'google/gemini-2.5-flash-preview:free',name:'Gemini 2.5 Flash',version:'2.5-flash'},{id:'google/gemini-2.0-flash-exp:free',name:'Gemini 2.0 Flash',version:'2.0-flash'},{id:'thudm/glm-4-air:free',name:'GLM-4.5 Air',version:'GLM-4.5'},{id:'meta-llama/llama-4-maverick:free',name:'Llama 4 Maverick',version:'Maverick'},{id:'meta-llama/llama-4-scout:free',name:'Llama 4 Scout',version:'Scout'},{id:'meta-llama/llama-3.3-70b-instruct:free',name:'Llama 3.3 70B',version:'70B'},{id:'moonshotai/kimi-vl-a3b-thinking:free',name:'Kimi VL Thinking',version:'VL-A3B'},{id:'nvidia/llama-3.1-nemotron-nano-8b-v1:free',name:'Nemotron Nano 8B',version:'8B'},{id:'mistralai/mistral-small-3.1-24b-instruct:free',name:'Mistral Small 24B',version:'24B'},{id:'openrouter/optimus-alpha',name:'Optimus Alpha',version:'Alpha'},{id:'openrouter/quasar-alpha',name:'Quasar Alpha',version:'Alpha'},{id:'deepseek/deepseek-v3-base:free',name:'DeepSeek V3 Base',version:'V3-base'},{id:'deepseek/deepseek-chat-v3-0324:free',name:'DeepSeek Chat V3',version:'V3-chat'},{id:'deepseek/deepseek-r1:free',name:'DeepSeek R1',version:'R1'},{id:'deepseek/deepseek-r1-zero:free',name:'DeepSeek R1 Zero',version:'R1-zero'},{id:'qwen/qwen2.5-vl-3b-instruct:free',name:'Qwen 2.5 VL 3B',version:'VL-3B'},{id:'qwen/qwen3-32b:free',name:'Qwen3 32B',version:'32B'},{id:'nousresearch/deephermes-3-llama-3-8b-preview:free',name:'DeepHermes 3 8B',version:'8B'},{id:'allenai/olmo-3.1-32b-think:free',name:'OLMo 3.1 32B',version:'32B'},{id:'amazon/nova-micro-v1',name:'Nova Micro',version:'Micro'},{id:'amazon/nova-lite-v1',name:'Nova Lite',version:'Lite'},{id:'amazon/nova-pro-v1',name:'Nova Pro',version:'Pro'}]},huggingface:{name:'HuggingFace',requiresKey:true,keyEnv:'HUGGINGFACE_API_KEY',models:[{id:'meta-llama/Meta-Llama-3.1-8B-Instruct',name:'Llama 3.1 8B',version:'3.1-8B'},{id:'HuggingFaceH4/zephyr-7b-beta',name:'Zephyr 7B',version:'7B-beta'},{id:'mistralai/Mistral-7B-Instruct-v0.1',name:'Mistral 7B',version:'7B-v0.1'},{id:'google/flan-t5-large',name:'Flan T5 Large',version:'T5-large'},{id:'EleutherAI/gpt-j-6B',name:'GPT-J 6B',version:'6B'}]}};
const TTS_PROVIDERS={edge:{name:'Edge TTS',requiresKey:false,voices:[{id:'id-ID-GadisNeural',name:'Gadis (ID)',lang:'id'},{id:'id-ID-ArdiNeural',name:'Ardi (ID)',lang:'id'},{id:'en-US-JennyNeural',name:'Jenny (US)',lang:'en'},{id:'en-US-GuyNeural',name:'Guy (US)',lang:'en'},{id:'en-US-AriaNeural',name:'Aria (US)',lang:'en'},{id:'ja-JP-NanamiNeural',name:'Nanami (JP)',lang:'ja'},{id:'ko-KR-SunHiNeural',name:'SunHi (KR)',lang:'ko'},{id:'zh-CN-XiaoxiaoNeural',name:'Xiaoxiao (CN)',lang:'zh'}]},pollinations:{name:'Pollinations TTS',requiresKey:false,voices:[{id:'alloy',name:'Alloy',lang:'multi'},{id:'echo',name:'Echo',lang:'multi'},{id:'nova',name:'Nova',lang:'multi'},{id:'shimmer',name:'Shimmer',lang:'multi'}]}};
const DEFAULT_SETTINGS={aiProvider:'gemini',aiModel:'gemini-2.5-flash',ttsProvider:'edge',ttsVoice:'id-ID-GadisNeural',mode:'voice',ttsOutput:'auto',searchEnabled:true,searchProvider:'auto',systemPrompt:SYSTEM_PROMPT};
const client=new Client({intents:[GatewayIntentBits.Guilds,GatewayIntentBits.GuildMessages,GatewayIntentBits.MessageContent,GatewayIntentBits.GuildVoiceStates,GatewayIntentBits.GuildMembers]});
const guildSettings=new Map(),voiceConnections=new Map(),audioPlayers=new Map(),ttsQueues=new Map(),voiceTimeouts=new Map(),conversations=new Map();
function getConversation(g,u){const k=`${g}-${u}`;if(!conversations.has(k))conversations.set(k,{messages:[],createdAt:Date.now(),lastActivity:Date.now()});const c=conversations.get(k);c.lastActivity=Date.now();return c;}
function addToConversation(g,u,r,c){const conv=getConversation(g,u);conv.messages.push({role:r,content:c,timestamp:Date.now()});if(conv.messages.length>CONFIG.maxConversationMessages)conv.messages=conv.messages.slice(-CONFIG.maxConversationMessages);return conv;}
function clearConversation(g,u){conversations.delete(`${g}-${u}`);}
setInterval(()=>{const n=Date.now();for(const[k,c]of conversations)if(n-c.lastActivity>CONFIG.maxConversationAge)conversations.delete(k);},300000);
function ensureTempDir(){if(!fs.existsSync(CONFIG.tempPath))fs.mkdirSync(CONFIG.tempPath,{recursive:true});}
function cleanupFile(f){try{if(f&&fs.existsSync(f))fs.unlinkSync(f);}catch{}}
function cleanupFiles(f){if(Array.isArray(f))f.forEach(x=>cleanupFile(x));else cleanupFile(f);}
setInterval(()=>{try{const files=fs.readdirSync(CONFIG.tempPath),n=Date.now();files.forEach(f=>{const p=path.join(CONFIG.tempPath,f);try{if(n-fs.statSync(p).mtimeMs>600000)cleanupFile(p);}catch{}});}catch{}},300000);
function cleanTextForTTS(t){return t.replace(/https?:\/\/[^\s]+/g,'').replace(/\[([^\]]+)\]\([^)]+\)/g,'$1').replace(/[\u{1F300}-\u{1F9FF}]/gu,'').replace(/```[\s\S]*?```/g,' kode ').replace(/`([^`]+)`/g,'$1').replace(/\*\*([^*]+)\*\*/g,'$1').replace(/\*([^*]+)\*/g,'$1').replace(/#{1,6}\s*/g,'').replace(/\s+/g,' ').trim();}
function splitTextForTTS(t,m=CONFIG.ttsMaxChunkLength){const c=cleanTextForTTS(t);if(!c||c.length<CONFIG.ttsMinChunkLength)return[];const l=c.slice(0,CONFIG.ttsMaxTotalLength);if(l.length<=m)return[l];const chunks=[];let r=l;while(r.length>0){if(r.length<=m){if(r.trim().length>=CONFIG.ttsMinChunkLength)chunks.push(r.trim());break;}let i=r.slice(0,m).lastIndexOf('. ');if(i<m/3)i=r.slice(0,m).lastIndexOf(' ');if(i<0)i=m;chunks.push(r.slice(0,i).trim());r=r.slice(i).trim();}return chunks.filter(x=>x.length>=CONFIG.ttsMinChunkLength);}
function loadSettings(){try{if(fs.existsSync(CONFIG.dataPath)){const d=JSON.parse(fs.readFileSync(CONFIG.dataPath,'utf8'));Object.entries(d).forEach(([i,s])=>guildSettings.set(i,{...DEFAULT_SETTINGS,...s}));}}catch{}}
function saveSettings(){try{const d=path.dirname(CONFIG.dataPath);if(!fs.existsSync(d))fs.mkdirSync(d,{recursive:true});const data={};guildSettings.forEach((s,i)=>data[i]=s);fs.writeFileSync(CONFIG.dataPath,JSON.stringify(data));}catch{}}
function getSettings(g){if(!guildSettings.has(g))guildSettings.set(g,{...DEFAULT_SETTINGS});return guildSettings.get(g);}
function updateSettings(g,k,v){const s=getSettings(g);s[k]=v;saveSettings();}
function isAdmin(u){return CONFIG.adminIds.includes(u);}
function getModelInfo(p,m){const pr=AI_PROVIDERS[p];if(!pr)return{name:m,version:'?'};return pr.models.find(x=>x.id===m)||{name:m,version:'?'};}
function splitMessage(t,m=1900){if(t.length<=m)return[t];const p=[];let r=t;while(r.length>0){if(r.length<=m){p.push(r);break;}let i=r.lastIndexOf('\n',m);if(i<m/2)i=r.lastIndexOf(' ',m);if(i<0)i=m;p.push(r.slice(0,i));r=r.slice(i);}return p;}
function httpRequest(o,b){return new Promise((res,rej)=>{const req=https.request(o,r=>{let d='';r.on('data',c=>d+=c);r.on('end',()=>res({data:d,statusCode:r.statusCode}));});req.on('error',rej);req.setTimeout(60000,()=>{req.destroy();rej(new Error('Timeout'));});if(b)req.write(b);req.end();});}
async function callGemini(m,msg,h,sp){const k=CONFIG.geminiApiKey;if(!k)throw new Error('GEMINI_API_KEY not set');const contents=[];h.slice(-40).forEach(x=>contents.push({role:x.role==='assistant'?'model':'user',parts:[{text:x.content}]}));contents.push({role:'user',parts:[{text:msg}]});const body={contents,systemInstruction:{parts:[{text:sp}]},generationConfig:{temperature:0.7,maxOutputTokens:2048},safetySettings:[{category:'HARM_CATEGORY_HARASSMENT',threshold:'BLOCK_NONE'},{category:'HARM_CATEGORY_HATE_SPEECH',threshold:'BLOCK_NONE'},{category:'HARM_CATEGORY_SEXUALLY_EXPLICIT',threshold:'BLOCK_NONE'},{category:'HARM_CATEGORY_DANGEROUS_CONTENT',threshold:'BLOCK_NONE'}]};const{data,statusCode}=await httpRequest({hostname:'generativelanguage.googleapis.com',path:`/v1beta/models/${m}:generateContent?key=${k}`,method:'POST',headers:{'Content-Type':'application/json'}},JSON.stringify(body));if(statusCode!==200)throw new Error(JSON.parse(data).error?.message||`HTTP ${statusCode}`);const r=JSON.parse(data);if(r.candidates?.[0]?.content?.parts?.[0]?.text)return r.candidates[0].content.parts[0].text;throw new Error('No response');}
async function callGroq(m,msg,h,sp){const k=CONFIG.groqApiKey;if(!k)throw new Error('GROQ_API_KEY not set');const messages=[{role:'system',content:sp},...h.slice(-50).map(x=>({role:x.role,content:x.content})),{role:'user',content:msg}];const{data,statusCode}=await httpRequest({hostname:'api.groq.com',path:'/openai/v1/chat/completions',method:'POST',headers:{'Authorization':`Bearer ${k}`,'Content-Type':'application/json'}},JSON.stringify({model:m,messages,max_tokens:2000,temperature:0.7}));if(statusCode!==200)throw new Error(JSON.parse(data).error?.message||`HTTP ${statusCode}`);return JSON.parse(data).choices[0].message.content;}
async function callPollinationsFree(m,msg,h,sp){let p=sp+'\n\n';h.slice(-20).forEach(x=>p+=x.role==='user'?`User: ${x.content}\n`:`Assistant: ${x.content}\n`);p+=`User: ${msg}\nAssistant:`;const e=encodeURIComponent(p.slice(0,8000));return new Promise((res,rej)=>{https.get(`https://text.pollinations.ai/${e}?model=${m}&seed=${Math.floor(Math.random()*1000000)}`,{timeout:60000},r=>{let d='';r.on('data',c=>d+=c);r.on('end',()=>{if(r.statusCode===200&&d.trim()){let x=d.trim();if(x.startsWith('Assistant:'))x=x.slice(10).trim();res(x);}else rej(new Error(`HTTP ${r.statusCode}`));});}).on('error',rej).on('timeout',()=>rej(new Error('Timeout')));});}
async function callPollinationsAPI(m,msg,h,sp){const k=CONFIG.pollinationsApiKey;if(!k)throw new Error('POLLINATIONS_API_KEY not set');const messages=[{role:'system',content:sp},...h.slice(-30).map(x=>({role:x.role,content:x.content})),{role:'user',content:msg}];const{data,statusCode}=await httpRequest({hostname:'gen.pollinations.ai',path:'/v1/chat/completions',method:'POST',headers:{'Authorization':`Bearer ${k}`,'Content-Type':'application/json'}},JSON.stringify({model:m,messages,max_tokens:2000,temperature:0.7}));if(statusCode!==200)throw new Error(`HTTP ${statusCode}`);const r=JSON.parse(data);if(r.choices?.[0]?.message?.content)return r.choices[0].message.content;throw new Error('No response');}
async function callOpenRouter(m,msg,h,sp){const k=CONFIG.openrouterApiKey;if(!k)throw new Error('OPENROUTER_API_KEY not set');const messages=[{role:'system',content:sp},...h.slice(-50).map(x=>({role:x.role,content:x.content})),{role:'user',content:msg}];const{data,statusCode}=await httpRequest({hostname:'openrouter.ai',path:'/api/v1/chat/completions',method:'POST',headers:{'Authorization':`Bearer ${k}`,'Content-Type':'application/json','HTTP-Referer':'https://discord.com'}},JSON.stringify({model:m,messages,max_tokens:2000,temperature:0.7}));if(statusCode!==200)throw new Error(JSON.parse(data).error?.message||`HTTP ${statusCode}`);return JSON.parse(data).choices[0].message.content;}
async function callHuggingFace(m,msg,h,sp){const k=CONFIG.huggingfaceApiKey;if(!k)throw new Error('HUGGINGFACE_API_KEY not set');let p=sp+'\n\n';h.slice(-20).forEach(x=>p+=x.role==='user'?`User: ${x.content}\n`:`Assistant: ${x.content}\n`);p+=`User: ${msg}\nAssistant:`;const{data,statusCode}=await httpRequest({hostname:'api-inference.huggingface.co',path:`/models/${m}`,method:'POST',headers:{'Authorization':`Bearer ${k}`,'Content-Type':'application/json'}},JSON.stringify({inputs:p,parameters:{max_new_tokens:1000}}));if(statusCode!==200)throw new Error(`HTTP ${statusCode}`);const r=JSON.parse(data);const t=Array.isArray(r)?r[0].generated_text:r.generated_text;return t.split('Assistant:').pop().trim();}
async function callAI(g,u,msg,v=false){const s=getSettings(g),{aiProvider,aiModel,systemPrompt,searchEnabled,searchProvider}=s,start=Date.now(),conv=getConversation(g,u),h=conv.messages;let sc='',sd=null;if(searchEnabled&&searchProvider!=='off'&&(CONFIG.tavilyApiKey||CONFIG.serperApiKey)&&shouldSearch(msg)){sd=await performSearch(msg,searchProvider);if(sd)sc=formatSearchForAI(sd);}let sp=systemPrompt+sc;if(v)sp+='\n[MODE SUARA: Jawab singkat 2-4 kalimat]';try{let r;switch(aiProvider){case'gemini':r=await callGemini(aiModel,msg,h,sp);break;case'groq':r=await callGroq(aiModel,msg,h,sp);break;case'pollinations_free':r=await callPollinationsFree(aiModel,msg,h,sp);break;case'pollinations_api':r=await callPollinationsAPI(aiModel,msg,h,sp);break;case'openrouter':r=await callOpenRouter(aiModel,msg,h,sp);break;case'huggingface':r=await callHuggingFace(aiModel,msg,h,sp);break;default:r=await callPollinationsFree('openai',msg,h,sp);}addToConversation(g,u,'user',msg);addToConversation(g,u,'assistant',r);const info=getModelInfo(aiProvider,aiModel);return{text:r,provider:AI_PROVIDERS[aiProvider]?.name||aiProvider,model:info.name,latency:Date.now()-start,searched:!!sd};}catch(e){console.error(`AI Error (${aiProvider}):`,e.message);if(aiProvider!=='pollinations_free'){try{const fb=await callPollinationsFree('openai',msg,h,sp);addToConversation(g,u,'user',msg);addToConversation(g,u,'assistant',fb);return{text:fb,provider:'Pollinations (Fallback)',model:'OpenAI GPT',latency:Date.now()-start,searched:!!sd};}catch(e2){throw new Error(`${e.message}, Fallback: ${e2.message}`);}}throw e;}}
function generateTTSChunk(t,v,p,o){return new Promise((res,rej)=>{const st=t.replace(/"/g,"'").replace(/`/g,"'").replace(/\$/g,'').replace(/\\/g,'').replace(/\n/g,' ').trim();if(!st||st.length<2)return rej(new Error('Text too short'));const to=setTimeout(()=>rej(new Error('TTS timeout')),CONFIG.ttsGenerateTimeout);if(p==='edge'){exec(`edge-tts --voice "${v}" --text "${st}" --write-media "${o}"`,{timeout:CONFIG.ttsGenerateTimeout},(e)=>{clearTimeout(to);if(e)rej(e);else res(o);});}else if(p==='pollinations'){const e=encodeURIComponent(st),f=fs.createWriteStream(o);https.get(`https://text.pollinations.ai/${e}?model=openai-audio&voice=${v}`,r=>{clearTimeout(to);if(r.statusCode!==200){f.close();return rej(new Error(`HTTP ${r.statusCode}`));}r.pipe(f);f.on('finish',()=>{f.close();res(o);});}).on('error',e=>{clearTimeout(to);rej(e);});}else{exec(`edge-tts --voice "id-ID-GadisNeural" --text "${st}" --write-media "${o}"`,{timeout:CONFIG.ttsGenerateTimeout},(e)=>{clearTimeout(to);if(e)rej(e);else res(o);});}});}
function concatAudio(i,o){return new Promise((res,rej)=>{if(i.length===0)return rej(new Error('No input'));if(i.length===1){try{fs.copyFileSync(i[0],o);return res(o);}catch(e){return rej(e);}}const lp=o.replace('.mp3','_list.txt'),lc=i.map(f=>`file '${path.resolve(f)}'`).join('\n');try{fs.writeFileSync(lp,lc);}catch(e){return rej(e);}exec(`ffmpeg -f concat -safe 0 -i "${lp}" -c:a libmp3lame -q:a 2 "${o}" -y`,{timeout:CONFIG.ttsConcatTimeout},(e)=>{cleanupFile(lp);if(e)rej(e);else res(o);});});}
async function generateTTS(g,t){const s=getSettings(g);ensureTempDir();const chunks=splitTextForTTS(t);if(chunks.length===0)return null;const sid=`${Date.now()}_${Math.random().toString(36).slice(2,8)}`,cf=[];try{for(let i=0;i<chunks.length;i++){const cp=path.join(CONFIG.tempPath,`tts_${sid}_${i}.mp3`);try{await generateTTSChunk(chunks[i],s.ttsVoice,s.ttsProvider,cp);if(fs.existsSync(cp)&&fs.statSync(cp).size>0)cf.push(cp);}catch(e){if(s.ttsProvider!=='edge'){try{await generateTTSChunk(chunks[i],'id-ID-GadisNeural','edge',cp);if(fs.existsSync(cp))cf.push(cp);}catch{}}}}if(cf.length===0)throw new Error('No TTS generated');if(cf.length===1)return{type:'single',file:cf[0],sessionId:sid};const comb=path.join(CONFIG.tempPath,`tts_${sid}_combined.mp3`);try{await concatAudio(cf,comb);cleanupFiles(cf);return{type:'combined',file:comb,sessionId:sid};}catch{return{type:'chunks',files:cf,sessionId:sid};}}catch(e){cleanupFiles(cf);throw e;}}
function resetVoiceTimeout(g){if(voiceTimeouts.has(g))clearTimeout(voiceTimeouts.get(g));voiceTimeouts.set(g,setTimeout(()=>{if(voiceConnections.get(g))leaveVoiceChannel({id:g});},CONFIG.voiceInactivityTimeout));}
async function joinUserVoiceChannel(m,g){const vc=m?.voice?.channel;if(!vc)return{success:false,error:'Masuk voice channel dulu'};try{const ec=getVoiceConnection(g.id);if(ec&&ec.joinConfig.channelId===vc.id){resetVoiceTimeout(g.id);return{success:true,channel:vc,alreadyConnected:true};}if(ec){ec.destroy();voiceConnections.delete(g.id);audioPlayers.delete(g.id);ttsQueues.delete(g.id);}const conn=joinVoiceChannel({channelId:vc.id,guildId:g.id,adapterCreator:g.voiceAdapterCreator,selfDeaf:false});await entersState(conn,VoiceConnectionStatus.Ready,30000);const player=createAudioPlayer();conn.subscribe(player);voiceConnections.set(g.id,conn);audioPlayers.set(g.id,player);ttsQueues.set(g.id,{queue:[],playing:false,currentFile:null});player.on(AudioPlayerStatus.Idle,()=>processQueue(g.id));player.on('error',()=>processQueue(g.id));resetVoiceTimeout(g.id);return{success:true,channel:vc};}catch(e){return{success:false,error:e.message};}}
async function leaveVoiceChannel(g){const gid=g.id||g,conn=voiceConnections.get(gid)||getVoiceConnection(gid);if(voiceTimeouts.has(gid)){clearTimeout(voiceTimeouts.get(gid));voiceTimeouts.delete(gid);}const q=ttsQueues.get(gid);if(q){if(q.currentFile)cleanupFile(q.currentFile);q.queue.forEach(x=>cleanupFile(x.file));}if(!conn)return false;conn.destroy();voiceConnections.delete(gid);audioPlayers.delete(gid);ttsQueues.delete(gid);return true;}
function processQueue(g){const q=ttsQueues.get(g);if(!q)return;if(q.currentFile){cleanupFile(q.currentFile);q.currentFile=null;}if(q.queue.length===0){q.playing=false;resetVoiceTimeout(g);return;}const player=audioPlayers.get(g);if(!player)return;const next=q.queue.shift();q.currentFile=next.file;q.playing=true;try{player.play(createAudioResource(next.file,{inputType:StreamType.Arbitrary}));resetVoiceTimeout(g);}catch{cleanupFile(next.file);processQueue(g);}}
function addToQueue(g,tts){let q=ttsQueues.get(g);if(!q){q={queue:[],playing:false,currentFile:null};ttsQueues.set(g,q);}if(tts.type==='single'||tts.type==='combined')q.queue.push({file:tts.file});else if(tts.type==='chunks')tts.files.forEach(f=>q.queue.push({file:f}));if(!q.playing)processQueue(g);}
async function playTTS(g,tts){const p=audioPlayers.get(g);if(!p)return false;addToQueue(g,tts);return true;}
async function sendTTSFile(ch,tts){try{let fp,cl=[];if(tts.type==='single'||tts.type==='combined')fp=tts.file;else{const cp=path.join(CONFIG.tempPath,`tts_${tts.sessionId}_file.mp3`);try{await concatAudio(tts.files,cp);fp=cp;cl=tts.files;}catch{fp=tts.files[0];cl=tts.files.slice(1);}}await ch.send({files:[new AttachmentBuilder(fp,{name:`aria_${Date.now()}.mp3`})]});cleanupFile(fp);cleanupFiles(cl);return true;}catch{return false;}}
function createSettingsEmbed(g){const s=getSettings(g),ai=AI_PROVIDERS[s.aiProvider],tts=TTS_PROVIDERS[s.ttsProvider],m=getModelInfo(s.aiProvider,s.aiModel);let ss=s.searchProvider==='off'?'ğŸ”´ Off':(CONFIG.tavilyApiKey||CONFIG.serperApiKey)?'ğŸŸ¢ Auto':'ğŸ”´ No Key';return new EmbedBuilder().setColor(0x5865F2).setTitle('âš™ï¸ Settings').addFields({name:'ğŸ§  AI',value:`${ai?.name}\n${m.name}`,inline:true},{name:'ğŸ”Š TTS',value:`${tts?.name}\n${s.ttsVoice.split('-').pop()}`,inline:true},{name:'ğŸ” Search',value:ss,inline:true}).setFooter({text:'v2.13.0'}).setTimestamp();}
function createAIMenu(g){const s=getSettings(g);return new ActionRowBuilder().addComponents(new StringSelectMenuBuilder().setCustomId('sel_ai').setPlaceholder('ğŸ§  AI Provider').addOptions(Object.entries(AI_PROVIDERS).map(([k,p])=>({label:p.name.slice(0,25),value:k,description:`${p.models.length} models`,default:k===s.aiProvider,emoji:(!p.requiresKey||process.env[p.keyEnv])?'ğŸŸ¢':'ğŸ”´'}))));}
function createModelMenu(g){const s=getSettings(g),p=AI_PROVIDERS[s.aiProvider];if(!p)return null;const models=p.models.filter(m=>!['stt','guard'].includes(m.category)).slice(0,25);if(models.length===0)return null;return new ActionRowBuilder().addComponents(new StringSelectMenuBuilder().setCustomId('sel_model').setPlaceholder('ğŸ¤– Model').addOptions(models.map(m=>({label:m.name.slice(0,25),description:m.version,value:m.id,default:m.id===s.aiModel}))));}
function createTTSMenu(g){const s=getSettings(g);return new ActionRowBuilder().addComponents(new StringSelectMenuBuilder().setCustomId('sel_tts').setPlaceholder('ğŸ”Š TTS').addOptions(Object.entries(TTS_PROVIDERS).map(([k,p])=>({label:p.name,value:k,description:`${p.voices.length} voices`,default:k===s.ttsProvider}))));}
function createVoiceMenu(g){const s=getSettings(g),p=TTS_PROVIDERS[s.ttsProvider];if(!p)return null;return new ActionRowBuilder().addComponents(new StringSelectMenuBuilder().setCustomId('sel_voice').setPlaceholder('ğŸ¤ Voice').addOptions(p.voices.slice(0,25).map(v=>({label:v.name,description:v.lang,value:v.id,default:v.id===s.ttsVoice}))));}
function createButtons(g){const s=getSettings(g);return new ActionRowBuilder().addComponents(new ButtonBuilder().setCustomId('mode_text').setLabel('ğŸ“').setStyle(s.mode==='text'?ButtonStyle.Primary:ButtonStyle.Secondary),new ButtonBuilder().setCustomId('mode_voice').setLabel('ğŸ”Š').setStyle(s.mode==='voice'?ButtonStyle.Primary:ButtonStyle.Secondary),new ButtonBuilder().setCustomId('tts_toggle').setLabel(`ğŸµ${s.ttsOutput||'auto'}`).setStyle(ButtonStyle.Secondary),new ButtonBuilder().setCustomId('search_toggle').setLabel(`ğŸ”${s.searchProvider||'auto'}`).setStyle(s.searchProvider==='off'?ButtonStyle.Danger:ButtonStyle.Success),new ButtonBuilder().setCustomId('refresh').setLabel('ğŸ”„').setStyle(ButtonStyle.Secondary));}
async function handleAI(msg,q){const g=msg.guild.id,u=msg.author.id,s=getSettings(g);const rl=checkRateLimit(u);if(!rl.allowed)return msg.reply(`â³ Tunggu ${rl.waitTime}s`);if(q.length>4000)return msg.reply('âŒ Pesan terlalu panjang');const vm=s.mode==='voice';let inVC=false;if(vm&&msg.member?.voice?.channel&&s.ttsOutput!=='file'){const r=await joinUserVoiceChannel(msg.member,msg.guild);if(r.success)inVC=true;}await msg.channel.sendTyping();try{const r=await callAI(g,u,q,vm);const info=`*${r.model} â€¢ ${r.latency}ms${r.searched?' ğŸ”':''}*`;const full=`${r.text}\n\n-# ${info}`;const parts=splitMessage(full);for(let i=0;i<parts.length;i++){if(i===0)await msg.reply(parts[i]);else await msg.channel.send(parts[i]);}if(vm){try{const tts=await generateTTS(g,r.text);if(tts){if(s.ttsOutput==='auto'){if(inVC)await playTTS(g,tts);else await sendTTSFile(msg.channel,tts);}else if(s.ttsOutput==='voice'&&inVC)await playTTS(g,tts);else await sendTTSFile(msg.channel,tts);}}catch{}}}catch(e){await msg.reply(`âŒ Error: ${e.message}`);}}
async function showSettings(msg){if(!isAdmin(msg.author.id))return msg.reply('âŒ Admin only');const comps=[createAIMenu(msg.guild.id),createModelMenu(msg.guild.id),createTTSMenu(msg.guild.id),createVoiceMenu(msg.guild.id),createButtons(msg.guild.id)].filter(Boolean);await msg.reply({embeds:[createSettingsEmbed(msg.guild.id)],components:comps});}
client.on(Events.InteractionCreate,async(i)=>{if(!i.isStringSelectMenu()&&!i.isButton())return;if(!isAdmin(i.user.id))return i.reply({content:'âŒ Admin only',ephemeral:true});const g=i.guild.id;try{if(i.customId==='sel_ai'){const p=AI_PROVIDERS[i.values[0]];if(!p)return i.reply({content:'âŒ Invalid',ephemeral:true});if(p.requiresKey&&!process.env[p.keyEnv])return i.reply({content:`âŒ ${p.keyEnv} missing`,ephemeral:true});updateSettings(g,'aiProvider',i.values[0]);if(p.models.length>0)updateSettings(g,'aiModel',p.models[0].id);}else if(i.customId==='sel_model')updateSettings(g,'aiModel',i.values[0]);else if(i.customId==='sel_tts'){const p=TTS_PROVIDERS[i.values[0]];if(p){updateSettings(g,'ttsProvider',i.values[0]);updateSettings(g,'ttsVoice',p.voices[0].id);}}else if(i.customId==='sel_voice')updateSettings(g,'ttsVoice',i.values[0]);else if(i.customId==='mode_text')updateSettings(g,'mode','text');else if(i.customId==='mode_voice')updateSettings(g,'mode','voice');else if(i.customId==='tts_toggle'){const s=getSettings(g),o=['auto','file','voice'],idx=o.indexOf(s.ttsOutput||'auto');updateSettings(g,'ttsOutput',o[(idx+1)%3]);}else if(i.customId==='search_toggle'){const s=getSettings(g),o=['auto','serper','tavily','off'],idx=o.indexOf(s.searchProvider||'auto');updateSettings(g,'searchProvider',o[(idx+1)%4]);}const comps=[createAIMenu(g),createModelMenu(g),createTTSMenu(g),createVoiceMenu(g),createButtons(g)].filter(Boolean);await i.update({embeds:[createSettingsEmbed(g)],components:comps});}catch(e){i.reply({content:`âŒ ${e.message}`,ephemeral:true}).catch(()=>{});}});
client.on(Events.MessageCreate,async(msg)=>{if(msg.author.bot||!msg.guild)return;const mentioned=msg.mentions.has(client.user);let content=msg.content;if(mentioned)content=content.replace(new RegExp(`<@!?${client.user.id}>`,'g'),'').trim();if(mentioned&&content)return handleAI(msg,content);if(!content.startsWith(CONFIG.prefix))return;const args=content.slice(CONFIG.prefix.length).trim().split(/ +/),cmd=args.shift().toLowerCase();try{switch(cmd){case'ai':case'ask':case'tanya':if(!args.join(' '))return msg.reply('â“ `.ai pertanyaan`');await handleAI(msg,args.join(' '));break;case'search':case'cari':if(!args.join(' '))return msg.reply('â“ `.search query`');await msg.channel.sendTyping();const sr=await performSearch(args.join(' '),getSettings(msg.guild.id).searchProvider);if(!sr)return msg.reply('âŒ No results');let disp=`ğŸ” **${args.join(' ')}**\nğŸ“… ${sr.timestamp}\n\n`;if(sr.answer)disp+=`**Jawaban:** ${sr.answer}\n\n`;sr.facts.slice(0,3).forEach((f,i)=>disp+=`${i+1}. ${f.slice(0,200)}...\n`);await msg.channel.send(disp);break;case'setsearch':if(!isAdmin(msg.author.id))return msg.reply('âŒ Admin only');const valid=['auto','serper','tavily','off'],p=args[0]?.toLowerCase();if(!p||!valid.includes(p))return msg.reply(`ğŸ” Options: auto, serper, tavily, off\nSerper: ${CONFIG.serperApiKey?'âœ…':'âŒ'} | Tavily: ${CONFIG.tavilyApiKey?'âœ…':'âŒ'}`);updateSettings(msg.guild.id,'searchProvider',p);await msg.reply(`âœ… Search: ${p}`);break;case'speak':case'tts':if(!args.join(' '))return msg.reply('â“ `.speak text`');const sm=await msg.reply('ğŸ”Š Generating...');try{const tts=await generateTTS(msg.guild.id,args.join(' '));if(!tts)return sm.edit('âŒ Failed');const player=audioPlayers.get(msg.guild.id);if(player&&msg.member?.voice?.channel){await playTTS(msg.guild.id,tts);await sm.edit('ğŸ”Š Playing...');}else{await sendTTSFile(msg.channel,tts);await sm.delete().catch(()=>{});}}catch(e){await sm.edit(`âŒ ${e.message}`);}break;case'stop':const player=audioPlayers.get(msg.guild.id),q=ttsQueues.get(msg.guild.id);if(!player)return msg.reply('âŒ Nothing playing');if(q){if(q.currentFile)cleanupFile(q.currentFile);q.queue.forEach(x=>cleanupFile(x.file));q.queue=[];q.playing=false;q.currentFile=null;}player.stop();await msg.reply('â¹ï¸ Stopped');break;case'join':case'j':const jr=await joinUserVoiceChannel(msg.member,msg.guild);await msg.reply(jr.success?`ğŸ”Š ${jr.alreadyConnected?'Already in':'Joined'} **${jr.channel.name}**`:`âŒ ${jr.error}`);break;case'leave':case'dc':await msg.reply(await leaveVoiceChannel(msg.guild)?'ğŸ‘‹ Left':'âŒ Not in voice');break;case'settings':case'config':await showSettings(msg);break;case'status':const st=getSettings(msg.guild.id);await msg.reply(`**ğŸ“Š Status v2.13.0**\n\n**Search:** Serper ${CONFIG.serperApiKey?'ğŸŸ¢':'ğŸ”´'} | Tavily ${CONFIG.tavilyApiKey?'ğŸŸ¢':'ğŸ”´'}\n**AI:** Gemini ${CONFIG.geminiApiKey?'ğŸŸ¢':'ğŸ”´'} | Groq ${CONFIG.groqApiKey?'ğŸŸ¢':'ğŸ”´'} | OpenRouter ${CONFIG.openrouterApiKey?'ğŸŸ¢':'ğŸ”´'}\n**Pollinations:** Free ğŸŸ¢ | API ${CONFIG.pollinationsApiKey?'ğŸŸ¢':'ğŸ”´'}\n\n**Stats:** ${conversations.size} convos | ${voiceConnections.size} voice`);break;case'memory':case'mem':const cv=conversations.get(`${msg.guild.id}-${msg.author.id}`);if(!cv)return msg.reply('ğŸ“­ No history');await msg.reply(`ğŸ§  ${cv.messages.length}/${CONFIG.maxConversationMessages} messages`);break;case'clear':case'reset':clearConversation(msg.guild.id,msg.author.id);await msg.reply('ğŸ—‘ï¸ Cleared!');break;case'clearall':if(!isAdmin(msg.author.id))return msg.reply('âŒ Admin only');conversations.clear();await msg.reply('ğŸ—‘ï¸ All cleared');break;case'help':case'h':await msg.reply(`**ğŸ¤– Aria v2.13.0**\n\n**Chat:** \`.ai <question>\` or mention\n**Voice:** \`.join\` \`.leave\` \`.speak\` \`.stop\`\n**Search:** \`.search <query>\` \`.setsearch <auto|serper|tavily|off>\`\n**Memory:** \`.memory\` \`.clear\`\n**Settings:** \`.settings\` \`.status\``);break;case'ping':await msg.reply(`ğŸ“ ${Date.now()-msg.createdTimestamp}ms`);break;case'models':let mt='**ğŸ“¦ Models**\n\n';for(const[k,p]of Object.entries(AI_PROVIDERS)){const ok=!p.requiresKey||process.env[p.keyEnv];mt+=`${ok?'ğŸŸ¢':'ğŸ”´'} **${p.name}**: ${p.models.length}\n`;}await msg.reply(mt);break;}}catch(e){msg.reply(`âŒ ${e.message}`).catch(()=>{});}});
client.once(Events.ClientReady,()=>{console.log(`\n${'='.repeat(50)}\nğŸ¤– ${client.user.tag} online!\nğŸ“¡ ${client.guilds.cache.size} servers\nğŸ“¦ v2.13.0\n${'='.repeat(50)}`);console.log(`ğŸ” Serper: ${CONFIG.serperApiKey?'âœ…':'âŒ'} | Tavily: ${CONFIG.tavilyApiKey?'âœ…':'âŒ'}`);console.log(`ğŸ§  Gemini: ${CONFIG.geminiApiKey?'âœ…':'âŒ'} | Groq: ${CONFIG.groqApiKey?'âœ…':'âŒ'} | OpenRouter: ${CONFIG.openrouterApiKey?'âœ…':'âŒ'}`);console.log(`ğŸŒ¸ Pollinations API: ${CONFIG.pollinationsApiKey?'âœ…':'âŒ'}`);console.log('='.repeat(50)+'\n');client.user.setActivity('.ai | .help',{type:ActivityType.Listening});loadSettings();ensureTempDir();});
process.on('unhandledRejection',e=>console.error('Unhandled:',e));
process.on('uncaughtException',e=>console.error('Uncaught:',e));
process.on('SIGTERM',()=>{voiceConnections.forEach(c=>c.destroy());client.destroy();process.exit(0);});
if(!CONFIG.token){console.error('âŒ DISCORD_TOKEN not set!');process.exit(1);}
client.login(CONFIG.token);
